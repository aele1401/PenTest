# X-CORP

## Description
X-CORP is a comprehensive penetration testing and incident response project focused on evaluating the security posture of X-CORP's systems. This was done through simulating a Red Team and Blue Team environment, conducting a penetration test with modular, repeatable, and effective security testing processes while leveraging security tools for offensive security. As for defensive security, the task was to test, implement, and monitor alerts generated from SIEM and security tools to respond to security incidents. Also, to conduct network forensics to analyze and report on malicious activity not detected by security tools.

 The project involves various stages of pentesting, including reconnaissance, vulnerability assessment, exploitation, and post-exploitation analysis. It also incorporates the incident response cycle, including preparation, identification, containment, eradication, recovery, and lessons learned. The primary goal is to identify potential vulnerabilities and threats within X-CORP systems, assess their impact, implement new alerts and detections using data analysis, and provide recommendations for mitigating these risks.

## Overview
You are working as a Security Engineer for X-CORP, supporting the SOC infrastructure. The SOC Analysts have noticed some discrepancies with alerting in the Kibana system and the manager has asked the Security Engineering team to investigate. You will start by confirming that newly created Kibana alerts are working, after which you will monitor live traffic on the wire to detect any abnormalities that are not reflected in the alerting system. You are to report back all your findings to both the SOC Manager and the Engineering Manager with appropriate analysis.

## Key Features
* Offensive Security:
    - Reconnaissance: Gathering information on the target system, including network mapping and identifying potential attack vectors.
    - Vulnerability Assessment: Scanning the sytem for know vulnerabilities using industry-standard tools.
    - Exploitation: Attempting to exploit identified vulnerabilities to assess the extent of the security risk.
    - Post-Exploitation: Analyzing the impact of successful exploits, including privilege escalation and data exfiltration.
    - Reporting: Documenting findings, providing a risk assessment, and recommending security improvements.

* Defensive Security:
    - 

## Tools & Technologies
- Network & Vulnerability Scanners: Nmap, Netcat, and Nikto
- Exploitation Framework & Tools: Metasploit & John the Ripper
- Scripting Languages: Python, PHP, and SQL
- Post-Exploitation Tools: Cobalt Strike & Empire
- SIEM Tools: ELK & Elasticsearch Watcher
- Network Forenscis: Wireshark

## Installation

Vagrant was utilized in this project to automate the configuration of virtual machines.

1. Clone repo: Run `git clone https://github.com/aele1401/XCRP_PenTest.git`
2. Navigate to project directory: Run `cd XCRP_PenTest`
3. Update Linux environment: Run `sudo apt-get update && apt-get upgrade`
4. Install the necessary dependencies: Run `pip install -r requirements.txt`

## Table of Contents - Red Team 
This section contains the following resources:
- Network Topology
- Critical Vulnerabilities & Threats
- Exploits Used
- Avoiding Detection

## Table of Contents - Network Analysis
This section contains the following resources:
- Traffic Profiles
- Behavior Analysis
- Normal Activity
- Malicious Activity

## Table of Contents - Blue Team
This section contains the following resources:
- Alerts Implemented
- Hardening
- Implementing Patches
- Questions

## Network Topology
![Diagram](https://github.com/aele1401/XCRP_PenTest/blob/main/RvB/Architecture/XCRP_Topology.PNG)

## Red Team - Offensive Security
### Critical Vulnerabilities & Threats
#### Reconnaissance - Describing the Target
Nmap scan identified the following hosts on the network:
|             Hostname          |   IP Address  | Role on Network                        |
|-------------------------------|---------------|----------------------------------------|
| Azure Hyper-V ML-REFVM-684427 | 192.168.1.1   | Host Machine                           |
|             Kali              | 192.168.1.90  | Attack Machine                         |
|           Target 1            | 192.168.1.110 | Target Machine (Hosts WordPress app)   |
|           Target 2            | 192.168.1.115 | Target Machine 2 (Hosts web server)    |
|             ELK               | 192.168.1.100 | ELK Machine (network & system monitor) |
|           Capstone            | 192.168.1.105 | Testing Environment Machine            |

#### Vulnerability Assessment

- Assessment uncovered the following vulnerabilities in **Target 1**:
    * **Open Ports (CAPEC-300)**: Ports 22, 80, 111, 137 – 139, and 4444 are open and not monitored. Open ports that are not monitored and controlled can allow an attacker to exploit the services running on those ports, using those ports as points of entry.
        - Impact:
            * SSH with discovered credentials.
            * Access to web servers and DOS attacks.
    * **Enumeration & Account Footprinting (CAPEC-575)**: Web application vulnerability that allows attackers to use brute force techniques to validate users on a network or service.
        - Impact:
            * User enumeration on WordPress app.
            * App susceptible to brute force and DOS attacks.
    * **Weak Credentials (CWE-521)**: Short names, first names, or any simple combinations.
        - Impact:
            * Passwords easy to obtain.
            * Non-complex combinations.
            * User accounts compromised.
    * **Misconfigured Security Controls (CWE-284, CAPEC-122, and OWASP Top 10)**: Improper controls are implemented leaving systems vulnerable to exploits.
        - Impact:
            * Unauthorized access to SQL Database.
            * Data exfiltration.
            * Hash and data dumping.
            * Privilege escalation with sudo and custom scripts.
            * winPEAS privilege escalation.
    * **Confidential Data Improperly Secured (CWE-219 & CWE-522)**: Confidential data, such as users’ personal information and login information, is easily accessible to the public with no security.
        - Impact:
            * Access to authentication logs.
            * "WP-config.php" file accessibl.e
            * Entire WP directory accessible.
    * **Brute Force Attack & Insufficient Security Measures (CWE-307 & CWE-49)**: An attack that consists of systematically checking all possible username and password combinations until the correct one is found.
        - Impact:
            * Improper access controls.
            * Multiple failed login attempts.
            * WordPress app susceptible to brute forcing and password attacks.
    * **Directory Path Traversal (CWE-23 & CAPEC-126)**: Improper access control and filtering allowing access to restricted and hidden directories.
        - Impact:
            * Access to authentication directories.
            * Access to configuration files.
            * Access to web directories.
    * **Unsalted Passwords & Insufficient Computational Effort (CWE-916)**: Salting is adding additional values to hashed passwords, changing the hash value produced.
        - Impact:
            * Usernames and passwords
            * Password cracking (John, Hydra, Hashcat, etc.)
    * **Privilege Escalation & Root Access (CWE-284 & CAPEC-233)**: A security hole created when code is executed with higher privileges than those of the user running it.
        - Impact:
            * Privilege escalation
            * Elevated permissions
            - System control & command line
            - Access as admin
    * **XML-RPC Parsing (CWE-611 & CAPEC-230)**: XML-RPC parsing is a WordPress feature that allows for XML documents to be transmitted in a user-friendly manner using HTTP as the transport method and XML for encoding.
        - Impact:
            * XML-RPC parsing susceptible
            * Pingback.ping
            * Botnets & DDOS
            * Loss of availability
    * **XML-RPC Ping (CAPEC-147)**: WordPress can use XML-RPC to communicate with systems. It is used to help users create posts offline by connecting WordPress with other applications and systems remotely.
        - Impact:
            * HTTP POST request smuggling
            * Bypass front-end security controls
            * Ping floods & DOS
            * Loss of availability
    * **Plaintext/Unencrypted Administrative Credentials (CWE-256 & CAPEC-37)**: Protocols and authentication methods that leave credentials unencrypted, like basic authentication and telnet.
        * Impact:
            - Accessible admin credentials
            - Admin access to SQL DB
            - Credential theft
            - Unauthorized access
    * **Cloudflare Protection Bypass (CAPEC-554)**: WordPress uses Cloudflare to increase site speed with a content delivery network.
        - Impact:
            * Pingback.ping & DNS Protection
            * DNS Exploitation & Corruption
            * Query manipulation
            * DNS spoofing, hijacking, flooding, and amplification
            * Loss of availability
    * **Insecure Designs (OWASP Top 10)**: Faulty application design and flaws in architecture that hackers can exploit. Occurs when teams don’t adhere to security best practices, and they fail to adequately anticipate and evaluate potential threats during the code design phase of creating an application.
        - Impact:
            * REST API allows enumeration
            * Code execution with higher privileges
            * Access to back-end configuration and authentication files
    * **Vulnerable & Outdated Components (OWASP Top 10)**: Components refer to software elements (such as libraries, frameworks, modules, or plugins) within an application that have known security weaknesses or flaws or software elements that are running on older versions, and there may be newer releases or patches available.
        - Impact:
            * REST API
            * Java Libraries
            * EOSL
            * Zero-days 
    * **Crytpographic Failures (OWASP Top 10)**: Use of weak encryption algorithms or short encryption keys which can make it easier for attackers to decrypt sensitive data.
        - Impact:
            * Insecure algorithms
            * Usage of weak keys
            * Protocol flaws
            * Downgrade attacks
    * **Injection (OWASP Top 10)**: Attacks that exploit vulnerabilities in input validation and inadequate data handling. Attackers inject data such as SQL queries, code snippets, or commands into web application forms or URLs. They allow adversaries to access sensitive data and manipulate an application’s behavior or gain access into the network/system.
        - XSS
        - SQL
        - Command
        - LDAP
        - XML
        - Impact:
            * Session hijacking with WordPress
            * Arbitrary user inputs
            * Custom sudo python scripts
            * SMB client exploitation
            * Lateral movements with SMB
            * XML-RPC exploitaion
- Assessment uncovered the following vulnerabilities in **Target 2**:
    * **Local File Inclusion - LFI (CAPEC-252)**: LFI is a vulnerability in poorly designed web applications. This allows users to upload content into the application or servers.
        - Impact:
            * Malicious Payloads
            * Remote Access Trojan (RAT)
            * Direct command line access
            * Advanced Persistent Threat (APT)
    * **Directory Path Traversal (CWE-23 & CAPEC-126)**: Accessing restricted web directories through command injection and URL manipulation of variables and parameters that reference files or directories.
        - Impact:
            * Root web directory access
            * Establishes persistence with configuration changes
- Assessment uncovered the following threats:
    * **Trojan Malware (CWE-507)**: Malicious computer virus disguised as a legitimate program, but carries a malicious, hidden payload that has the potential to wreak havoc on a system or network.
        - Impact:
            * Malware downloaded locally
            * Infected multiple hosts
            * Source of infection identified
            * Threat contained and eradicated
    * Unauthorized Domain Setup: Private Active Directory domain created without authorization.
        - Impact:
            * Private domain creation
            * Illegal Torrenting
            * Detection avoidance
    * Illegal Torrenting: Downloading and uploading copyrighted files through a network.
        - Impact:
            * Copyright violations
            * Legal ramifications

### Exploits Used
#### Exploitation
- Port Scanning: Nmap scan shows IP addresses, ranges, OS versions, services, and open ports.
    * Open ports:
        - Port 22 - SSH
        - Port 80 - Web
        - Port 111 - RPC
        - Port 139 - NetBIOS
        - Port 445 - SMB
        - Port 4444 - TCP
    * Running services:
        - WordPress
        - Apache
        - SSH, RPC, HTTP, TCP, and SMB
    * Port 80 provides access to web server
- User Enumeration, Account Foot Printing, and LFI
    * Target 1 - WPSCAN to enumerate a list of site users (Michael & Steven)
        - `wpscan --url http://192.168.1.110/wordpress --enumerate u`
    * Target 2 - RAT uploaded to target for direct command line access
        - `nikto -C all -h 192.168.1.115
![Diagram]()
- SSH Using Discovered Credentials
    * SSH into target 1 machine: `SSH Michael@192.168.1.110`
    * Brute force password with guesses: `michael`
    * Granted user access
        - Michael's account compromised
![Diagram]()
- Weak User Credentials
    * Login with Michael's account
        - Michael's username and password were his first name
        - Password relatively easy to obtain through guessing
        - Online attack
![Diagram]()
- Misconfigured Security Controls
    * Privilege escalation without password (sudo python): `sudo python -c 'import pty;pty.spawn("/bin/bash")'`
    * Root shell access
    * *Recommendation: Steven's account should not have had access to run python with sudo and no password.*
![Diagram]()
- Confidential Data Improperly Secured
    * Back-end files (wp-config.php) file not secured
    * Dump the wp_user table containing password hashes
    * Crack password with John the Ripper
    * Tables can hold personal information, PHI and PII
![Diagram]()
![Diagram]()
![Diagram]()
- Brute Force & Insufficient Security Measures
    * Passwords can be brute forced
    * No limits to failed login attempts
    * WordPress susceptible to enumeration
![Diagram]()
![Diagram]()

### Avoiding Detection
#### Stealth Exploitation of Port Scanning
- Monitoring Overiew:
    * HTTP Request Size Monitor Alert
    * Sum of request bytes exceed 3500 per minute
    * Alert triggered after 3500 bytes
- Mitigation Detection:
    * Stealth scans like SYN scan or decoy scan
    * Slower scans by adjusting timing parameters
    * Fragmentation by obscuring contents of the packets
    * Proxy chains and anonymization by rerouting scan traffic to obfuscate the source of the scans
    * Protocol-Based scanning using less common protocols like ICMP echoes or SCTP
#### Stealth Exploitation of Enumeration
- Monitoring Overview:
    * Excessive HTTP Errors Alert
    * Top 5 response status codes exceed 400 every 5 minutes
    * Alert triggered after 400 threshold exceeded
- Mitigating Detection:
    * Enumerating is noisy
    * Stagger attempts
    * Reduce scan intensity 
    * Passive enumeration techniques
    * Stealthier scans, randomize timing, encrypt channels, and limit concurrent connections
#### Stealth Exploitation of LFI
- Monitoring Overview
    * CPU Usage Monitor Alert
    * CPU usage process exceeds 0.5/minute
    * Alert triggered after 50%
- Mitigation:
    * Alert is highly reliable
    * Fileless Malware & LOTL
    * Evade detection through refactoring
    * Obfuscation
    * Request splitting
    * User-agent spoofing
    * IP address rotation
    * Slow and Low technique
    * Bypass logging
    * Custom exploits

## Network Analysis 
### Traffic Profiles
#### Traffic Profile on 10.6.12.0/24
Wireshark analysis identified the following characteristics of the traffic on the network:
|            Hostname          |   IP Address  | Role on Network                         |
|-------------------------------|---------------|----------------------------------------|
| Top Talkers: 172.16. | 192.168.1.1   | Host Machine                           |
|             Kali              | 192.168.1.90  | Attack Machine                         |
|           Target 1            | 192.168.1.110 | Target Machine (Hosts WordPress app)   |
|           Target 2            | 192.168.1.115 | Target Machine 2 (Hosts web server)    |
|             ELK               | 192.168.1.100 | ELK Machine (network & system monitor) |
|           Capstone            | 192.168.1.105 | Testing Environment Machine            |


    




